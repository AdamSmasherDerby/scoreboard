<!DOCTYPE html>
<html><head><title>Skin Editor</title>

<script type="text/javascript" src="/external/jquery/jquery.js"></script>

<script type="text/javascript" src="/javascript/scoreboard.js"></script>

<script type="text/javascript" >

function currentSkin() { return $("#skinSelect").children(":selected").val(); }

function toggleSelectionClass(base, target, name) {
  base.find("."+name).not(target.toggleClass(name)).removeClass(name);
}

function selectSkin() { toggleSelectionClass($(".topLevelDiv"), $(".topLevelDiv>[data-skin="+currentSkin()+"]"), "selectedSkin"); }

function addSkin(skin) {
  if (!skin.$sbId)
    return;

  // Set up skin aspect controls
  $("<div>").attr("data-skin", skin.$sbId).appendTo("#skinDiv")
    .append($("<label>").attr("for", skin.$sbId+"-fixAspect").html("Fix aspect"))
    .append(skin.$sb("aspect.fix").$sbControl("<input type=checkbox>").attr("id", skin.$sbId+"-fixAspect"))
    .append($("<label>").attr("for", skin.$sbId+"-overflowAspect").html("Overflow window"))
    .append(skin.$sb("aspect.overflow").$sbControl("<input type=checkbox>").attr("id", skin.$sbId+"-overflowAspect"))
    .append("<a>Aspect: </a>")
    .append(skin.$sb("aspect.ratio.n").$sbControl("<input type=text size=3>", { id: skin.$sbId+"-ratioN", sbcontrol: { useNumber: true } }))
    .append("<a>x</a>")
    .append(skin.$sb("aspect.ratio.d").$sbControl("<input type=text size=3>", { id: skin.$sbId+"-ratioD", sbcontrol: { useNumber: true } }))
  ;

  // Set up panel for new skin
  $("<div>").attr("data-skin", skin.$sbId).appendTo("#panelDiv");

  // Set up tree for new skin
  addElements($("<ul>").attr("data-skin", skin.$sbId).appendTo("#treeDiv"), skin).click(function(event) {
      if ($(event.target).is("a")) {
//FIXME - this uses implementation details (500 ms for dbl-click interval, and lastClick time) from scoreboard.js, replace this with api related to editOnClick class (maybe provide parameter for dbl-click interval in class?)
        if (isNaN($(event.target).data("sbcontrol").lastClick) || (500 <= (event.timeStamp - $(event.target).data("sbcontrol").lastClick))) {
          toggleSelectionClass($(this), $(event.target).parent("li"), "selectedTreeNode");
          toggleSelectionClass($("#panelDiv>div[data-skin="+$(this).attr("data-skin")+"]"), $("#panelDiv>div[data-skin="+$(this).attr("data-skin")+"]>div[data-sbpath="+$(event.target).parent("li").attr("data-sbpath")+"]"), "selectedPanelNode");
        }
        $(event.target).data("lastClick", event.timeStamp);
      }
    });
  skin.bind("add:box add:display", function(event, child) { addElement($("#treeDiv>ul[data-skin="+$sb(event.target).$sbId+"],#treeDiv li[data-sbpath="+$sb(event.target).$sbPath+"]>ul"), $sb(child)); });
  skin.bind("remove:box remove:display", function(event, child) { removeElement($("#treeDiv>ul[data-skin="+$sb(event.target).$sbId+"],#treeDiv li[data-sbpath="+$sb(event.target).$sbPath+"]>ul"), $sb(child)); });

  if ($("#skinSelect").append("<option>"+skin.$sbId+"</option>").find("option").length == 1)
    selectSkin();
}

function removeSkin(skin) {
  $("#skinSelect").children("option:contains("+skin.$sbId+")").remove();
  $(".topLevelDiv>[data-skin="+skin.$sbId+"]").remove();
  selectSkin();
}

function currentSelectedNode() { return $("#treeDiv>ul.selectedSkin li.selectedTreeNode"); }

function createNewElement(type, base, name) {
  if (!base && currentSelectedNode().length)
    base = $sb(currentSelectedNode().attr("data-sbpath"));
  if (!base && currentSkin())
    base = $sb("Skins>Skin("+currentSkin()+")");
  if (!base)
    return;

  if (!name)
    name = "New "+type;

  /* Only top-level Skin and lower-level box elements can contain other elements; display elements are leaves */
  if (base.$sbName == "box" || base.$sbName == "Skin") {
    var child = base.$sb(type+"("+$sb().$sbNewUUID()+")");
    child.$sb("name").$sbSet(name);
    if (type == "box") {
      child.$sb("css.left").$sbSet("0%");
      child.$sb("css.top").$sbSet("0%");
      child.$sb("css.width").$sbSet("100%");
      child.$sb("css.height").$sbSet("100%");
      child.$sb("css.borderColor").$sbSet("black");
    }
    if (type == "display") {
      child.$sb("type").$sbSet("a");
      child.$sb("sourcetype").$sbSet("static");
      child.$sb("css.fontSize").$sbSet("5");
    }
  }
}

function removeSelectedElement() {
  var path = currentSelectedNode().attr("data-sbpath");
  if (path)
    $sb(path).$sbRemove();
}

function addElements(ul, e) {
  e.children("box,display").each(function() { addElement(ul, $sb(this)); });
  return ul;
}

function addElement(ul, e) {
  if (ul.children("li").is("[data-sbpath="+e.$sbPath+"]"))
    return; // element already processed

  // Set up tree node for element
  var nameControl = e.$sb("name")
    .$sbControl("<a><input type=text>", { sbcontrol: { editOnClick: true, useDoubleClick: true } });
  var li = $("<li>").attr("data-sbpath", e.$sbPath).appendTo(ul).append(nameControl);
  if (e.$sbName == "box")
    addElements($("<ul>").appendTo(li), e);

  // Set up panel control for element
  createElementPanel(e, ul.closest("[data-skin]").attr("data-skin"));
}

function removeElement(ul, e) {
  ul.children("[data-sbpath="+e.$sbPath+"]").remove();
}

function createElementPanel(e, skinName) {
  var div = $("<div>")
    .attr("data-sbpath", e.$sbPath)
    .appendTo($("#panelDiv>div[data-skin="+skinName+"]"));
  if (e.$sbName == "box")
    div.append(createBoxPanel(e));
  else if (e.$sbName == "display")
    div.append(createDisplayPanel(e));
}

function createBoxPanel(e) {
  var css = e.$sb("css"),
    borderColorControl = css.$sb("borderColor").$sbControl("<input type=radio value='black'><input type=radio value='white'>"),
    dAttrs = { size: "3", sbcontrol: { suffix: "%", useNumber: true }},
    dSliderAttrs = { sbcontrol: $.extend({ slider: true }, dAttrs.sbcontrol) };
  var panel = $("<div>").css("margin", "1%");
  $.each([ "left", "width", "top", "height" ], function() {
    panel.append("<a>"+$.string(this).capitalize().str+":</a>")
      .append(css.$sb(this).$sbControl("<input type=text>", dAttrs))
      .append(css.$sb(this).$sbControl("<div>", dSliderAttrs));
  });

  return panel.append("<br>")
    .append("<a>Show outline:</a>").append(css.$sb("border").$sbControl("<input type=checkbox>", { sbcontrol: { trueString: "1px solid", falseString: "" }}))
    .append("<a>black:</a>").append(borderColorControl.first())
    .append("<a>white:</a>").append(borderColorControl.last())
    .append("<br>")
    .append("<a>Background color:</a>")
    .append(css.$sb("backgroundColor").$sbControl("<input type=text size=6>", { sbcontrol: { prefix: "#", colorPicker: true } }))
  ;
}

function createDisplayPanel(e) {
  var css = e.$sb("css");
  var sourceTypeRadio = e.$sb("sourcetype").$sbControl("<input type=radio value='static'><input type=radio value='sbelement'>");  
  return $("<div>").css("margin", "1%")
    .append("<a>Display element type:</a>")
    .append(e.$sb("type").$sbControl("<select>")
      .append($("<option>").html("Text").val("a"))
      .append($("<option>").html("Image").val("img"))
      .append($("<option>").html("Video").val("video")))
    .append("<br>")

    .append(sourceTypeRadio.first().attr("id", e.$sbPath+"-radioStatic"))
    .append($("<label>").attr("for", e.$sbPath+"-radioStatic").html("Static content:"))
    .append(e.$sb("static").$sbControl("<input type=text>"))
    .append("<br>")

    .append(sourceTypeRadio.last().attr("id", e.$sbPath+"-radioSbelement"))
    .append($("<label>").attr("for", e.$sbPath+"-radioSbelement").html("ScoreBoard Element:"))
    .append(e.$sb("sbelement").$sbControl("<select>", { sbcontrol : { sbelementSelect : true }}))
    .append("<hr>")

    .append("<a>Font size:</a>")
    .append(css.$sb("fontSize").$sbControl("<input type=text size=3>", { sbcontrol: { suffix: "%" } })).append("<br>")
    .append(css.$sb("fontSize").$sbControl("<div>", { sbcontrol: { suffix: "%", slider: true } }))
    .append("<br>")

    .append("<a>Text color</a>")
    .append(css.$sb("color").$sbControl("<input type=text size=6>", { sbcontrol: { prefix: "#", colorPicker: true } }))
  ;
}

$sb(function() {
  $("#newSkinName").bind("keyup mouseup change", function(event) {
    var v = $(event.target).val();
    if (v)
      $(event.target).val(v.replace(/[\(|\)|\']/g, ""));
  });
  $("#newSkinButton").click(function(event) {
    createNewElement("box", $sb("Skins.Skin("+$("#newSkinName").val()+")"), "Main Box");
    $("#newSkinName").val("");
  });
  $("#removeSkinButton").click(function(event) {
    if (currentSkin() && confirm("Remove Skin '"+currentSkin()+"'?"))
      $sb("Skins.Skin("+currentSkin()+")").$sbRemove();
  });

  $("#treeNewBox,#treeNewDisplay").click(function() { createNewElement($(this).attr("data-type")); });
  $("#treeRemove").click(removeSelectedElement);

  $sb("Skins").live("add:Skin", function(event, node) { addSkin(node); });
  $sb("Skins").live("remove:Skin", function(event, node) { removeSkin(node); });
  $sb("Skins").children("Skin").each(function() { addSkin($sb(this)); });

  $("#skinSelect").bind("change", selectSkin);
});

</script>

<style type="text/css" >

div { position: absolute; }

.topLevelDiv>[data-skin]:not(.selectedSkin) { display: none; }

#treeDiv>ul li.selectedTreeNode>a { background: #eeeeee; }

#panelDiv>div>div:not(.selectedPanelNode) { display: none; }

#panelDiv>div { left: 0%; top: 0%; width: 100%; height: 100%; }
#panelDiv>div>div { left: 0%; top: 0%; width: 100%; height: 100%; }

</style>

<body style="overflow: hidden;" >
<div id="mainDiv" style="position: fixed; top: 0%; left: 0%; width: 100%; height: 100%;" >

  <div style="top: 0%; left: 0%; width: 100%; height: 20%;" >
    <div id="skinDiv" class="topLevelDiv" style="top: 0%; left: 0%; width: 50%; height: 100%; border: 1px solid black;" >
      <p>
        <span><a>Skin: </a><select id="skinSelect" ></select></span>
        <span><button id="removeSkinButton" >Remove current Skin</button></span>
        <span><a>New Skin: </a><input id="newSkinName" type="text" /><input id="newSkinButton" type="button" value="Create" /></span>
      </p>
    </div>
  </div>
  <div style="top: 20%; left: 0%; width: 100%; height: 80%;" >
    <div id="treeButtonsDiv" style="top: 0%; left: 0%; width: 25%; height: 10%; border: 1px solid black;" >
      <button id="treeNewBox" data-type="box" >New box</button>
      <button id="treeNewDisplay" data-type="display" >New display element</button>
      <button id="treeRemove" >Remove selected element</button>
    </div>
    <div id="treeDiv" class="topLevelDiv" style="top: 10%; left: 0%; width: 25%; height: 90%; border: 1px solid black;" ></div>
    <div id="panelDiv" class="topLevelDiv" style="top: 0%; right: 0%; width: 75%; height: 100%; border: 1px solid black;" ></div>
  </div>

</div>

</body>

</html>

